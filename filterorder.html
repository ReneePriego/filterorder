<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tableau Filter Order</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: white; min-height: 100vh; padding: 20px; }
    .container { width: 100%; max-width: 900px; margin: 0 auto; display: flex; flex-direction: column; align-items: center; }
    .landing-page { background: white; border-radius: 20px; padding: 40px 40px 60px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); animation: slideIn 0.6s ease-out; border: none; width: 100%; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .cro-header { font-size: 24px; color: #00A1E0; font-weight: 600; margin-bottom: 10px; letter-spacing: 1px; }
    .logo { width: 160px; height: auto; display: block; margin: 0 auto 16px; }
    .landing-hero { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px; flex-wrap: wrap; }
    .hero-content { flex: 1 1 320px; text-align: center; }
    .cta-row { display: flex; align-items: center; justify-content: center; gap: 12px; flex-wrap: wrap; }
    .game-title { font-size: 48px; color: #00A1E0; font-weight: 800; margin-bottom: 30px; letter-spacing: 2px; }
    .game-description { font-size: 16px; color: black; line-height: 1.8; margin-bottom: 40px; max-width: 600px; margin-left: auto; margin-right: auto; }
    .start-btn { background: #00A1E0; color: white; border: none; padding: 18px 60px; font-size: 20px; font-weight: 700; border-radius: 50px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(0,161,224,0.2); letter-spacing: 1px; }
    .start-btn:hover { transform: translateY(-3px); box-shadow: 0 15px 40px rgba(0,161,224,0.5); }
    .start-btn:active { transform: translateY(-1px); }
    .game-page { display: none; background: white; border-radius: 20px; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideIn 0.6s ease-out; max-width: 900px; margin: 0 auto; width: 100%; }
    .game-page.active { display: block; }
    .game-header { text-align: center; margin-bottom: 24px; }
    .game-header h1 { font-size: 36px; color: #00A1E0; margin-bottom: 6px; }
    .subtitle { font-size: 15px; color: #004B87; margin-bottom: 12px; }
    .stats { display: flex; justify-content: center; gap: 30px; margin-top: 10px; font-size: 16px; color: #666; }
    .order-wrapper { display: grid; gap: 16px; width: 100%; }
    .cards { background: #f8f9fa; padding: 20px; border-radius: 15px; border: 2px solid #e0e0e0; display: grid; gap: 10px; }
    .card { background: white; border: 2px solid #ddd; border-radius: 10px; padding: 14px; font-weight: 700; color: #00A1E0; cursor: grab; transition: all 0.2s ease; }
    .card:hover { border-color: #00A1E0; box-shadow: 0 8px 18px rgba(0,161,224,0.2); transform: translateY(-2px); }
    .card.dragging { opacity: 0.6; }
    .drop-target { border: 2px dashed #00A1E0; border-radius: 10px; padding: 12px; background: #e8f4fb; }
    .card.color-1 { color: #00A1E0; }
    .card.color-2 { color: #28a745; }
    .card.color-3 { color: #ff9800; }
    .card.color-4 { color: #9c27b0; }
    .card.color-5 { color: #e91e63; }
    .card.color-6 { color: #3f51b5; }
    .card.color-7 { color: #009688; }
    .game-controls { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-top: 12px; }
    .game-btn { padding: 12px 30px; font-size: 16px; font-weight: 600; border: none; border-radius: 25px; cursor: pointer; transition: all 0.3s ease; }
    .btn-home { background: #00A1E0; color: white; }
    .btn-home:hover { background: #0088B3; transform: translateY(-2px); }
    .btn-link { padding: 10px 16px; border-radius: 10px; border: 2px solid #00A1E0; background: #e8f4fb; color: #004B87; font-weight: 600; text-decoration: none; cursor: pointer; display: inline-block; transition: all 0.2s ease; min-width: 160px; text-align: center; }
    .btn-link:hover { background: #00A1E0; color: #ffffff; box-shadow: 0 8px 18px rgba(0,0,0,0.08); transform: translateY(-1px); }
    .message { font-size: 16px; font-weight: 700; color: #208080; min-height: 22px; text-align: center; margin-top: 4px; }
    .win-screen { display: none; background: white; border-radius: 20px; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideIn 0.6s ease-out; max-width: 900px; width: 100%; margin: 0 auto; text-align: center; }
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; padding: 20px; z-index: 10; }
    .modal.active { display: flex; }
    .modal-content { background: #ffffff; padding: 24px; border-radius: 14px; max-width: 360px; width: 100%; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; }
    .modal-content h3 { margin-bottom: 12px; color: #004B87; }
    .modal-content input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ccc; margin-bottom: 12px; font-size: 16px; }
    .modal-actions { display: flex; gap: 10px; justify-content: center; }
    @media (max-width: 768px) { .game-title { font-size: 36px; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="landing-page" id="landingPage">
      <img class="logo" src="logo.png" alt="Logo">
      <div class="landing-hero">
        <div class="hero-content">
          <div class="cro-header">CRO Curiosity Cove</div>
          <h1 class="game-title">Filter Order</h1>
          <p class="game-description">Arrange Tableau filter operations in their correct execution order.</p>
          <div class="cta-row">
            <button class="start-btn" onclick="openNamePrompt()">Start Game</button>
          </div>
        </div>
      </div>
    </div>

    <div class="game-page" id="gamePage">
      <div class="game-header">
        <h1>Tableau Filter Order</h1>
        <div class="subtitle">Drag to reorder filters from first applied to last.</div>
        <div class="stats">
          <span>Attempts: <strong id="moves">0</strong></span>
        </div>
      </div>

      <div class="order-wrapper">
        <div class="cards" id="cardList"></div>
        <div class="message" id="message"></div>
        <div class="game-controls">
          <button class="game-btn btn-home" onclick="goHome()">Back to Home</button>
          <a id="csvLink" class="btn-link" download="filter-winners.csv" style="display:none;">Export winners CSV</a>
          <button id="resetWinnersBtn" class="btn-link" style="display:none;" onclick="resetWinners()">Reset winners</button>
        </div>
      </div>
    </div>

    <div class="win-screen" id="winScreen">
      <h1 style="color:#00A1E0; margin-bottom:12px;">Congratulations!</h1>
      <p style="margin-bottom:12px; color:#004B87;">You nailed the filter order.</p>
      <p id="winDetails" style="margin-bottom:12px; color:#004B87;"></p>
      <img src="champ.png" alt="Champion badge" style="width:260px; height:auto; margin:16px auto; display:block;">
      <div class="game-controls" style="justify-content:center; margin-top:16px;">
        <button class="game-btn btn-home" onclick="goHome()">Back to Home</button>
      </div>
    </div>

    <div class="modal" id="nameModal">
      <div class="modal-content">
        <h3>Enter your name</h3>
        <input type="text" id="playerNameInput" placeholder="Your name" />
        <div class="modal-actions">
          <button class="start-btn" style="padding:10px 20px; border-radius:10px;" onclick="confirmName()">Start</button>
          <button class="game-btn btn-home" style="padding:10px 20px; border-radius:10px;" onclick="closeNamePrompt()">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const ADMIN_USER = 'reneepriego';
    const CORRECT_ORDER = [
      'Extract filters',
      'Data source filters',
      'Context filters',
      'Set filters',
      'Dimension filters',
      'Measure filters',
      'Table calc filters'
    ];

    let currentOrder = [];
    let moves = 0;
    let playerName = '';
    let winners = [];
    let playedNames = new Set();

    function shuffle(arr) {
      return [...arr].sort(() => Math.random() - 0.5);
    }

    function buildCards() {
      currentOrder = shuffle(CORRECT_ORDER);
      renderCards();
      moves = 0;
      document.getElementById('moves').textContent = moves;
      document.getElementById('message').textContent = '';
    }

    function renderCards() {
      const list = document.getElementById('cardList');
      list.innerHTML = '';
      currentOrder.forEach((text, idx) => {
        const card = document.createElement('div');
        card.className = `card color-${(idx % 7) + 1}`;
        card.textContent = text;
        card.draggable = true;
        card.dataset.index = idx;
        card.addEventListener('dragstart', onDragStart);
        card.addEventListener('dragover', onDragOver);
        card.addEventListener('drop', onDrop);
        card.addEventListener('dragend', onDragEnd);
        list.appendChild(card);
      });
    }

    let dragIndex = null;
    function onDragStart(e) {
      dragIndex = Number(e.target.dataset.index);
      e.dataTransfer.effectAllowed = 'move';
      e.target.classList.add('dragging');
    }

    function onDragOver(e) {
      e.preventDefault();
      const target = e.currentTarget;
      target.classList.add('drop-target');
    }

    function onDrop(e) {
      e.preventDefault();
      const targetIndex = Number(e.currentTarget.dataset.index);
      if (dragIndex === null || targetIndex === dragIndex) return;
      const item = currentOrder.splice(dragIndex, 1)[0];
      currentOrder.splice(targetIndex, 0, item);
      dragIndex = null;
      cleanDropStyles();
      renderCards();
      checkOrder();
    }

    function onDragEnd() {
      dragIndex = null;
      cleanDropStyles();
    }

    function cleanDropStyles() {
      document.querySelectorAll('.card').forEach(c => c.classList.remove('dragging', 'drop-target'));
    }

    function checkOrder() {
      moves++;
      document.getElementById('moves').textContent = moves;
      const isCorrect = currentOrder.every((item, i) => item === CORRECT_ORDER[i]);
      if (isCorrect) {
        document.getElementById('message').textContent = 'âœ“ Correct order!';
        setTimeout(showWinScreen, 300);
      } else {
        document.getElementById('message').textContent = 'Keep adjusting the order.';
      }
    }

    function showWinScreen() {
      document.getElementById('gamePage').classList.remove('active');
      document.getElementById('winDetails').textContent = `Completed in ${moves} moves.`;
      document.getElementById('winScreen').style.display = 'block';
      recordWinner();
    }

    function startGame() {
      document.getElementById('landingPage').style.display = 'none';
      document.getElementById('winScreen').style.display = 'none';
      document.getElementById('gamePage').classList.add('active');
      buildCards();
    }

    function goHome() {
      document.getElementById('gamePage').classList.remove('active');
      document.getElementById('landingPage').style.display = 'block';
      document.getElementById('winScreen').style.display = 'none';
      document.getElementById('message').textContent = '';
    }

    function openNamePrompt() {
      document.getElementById('nameModal').classList.add('active');
      document.getElementById('playerNameInput').value = playerName || '';
      setTimeout(() => document.getElementById('playerNameInput').focus(), 0);
    }

    function closeNamePrompt() {
      document.getElementById('nameModal').classList.remove('active');
    }

    function confirmName() {
      const nameVal = document.getElementById('playerNameInput').value.trim();
      if (!nameVal) return;
      const normalized = nameVal.toLowerCase();
      const isAdmin = normalized === ADMIN_USER.toLowerCase();
      if (!isAdmin && playedNames.has(normalized)) {
        alert('This user already played. Please use a different name.');
        return;
      }
      playerName = nameVal;
      if (!isAdmin) {
        playedNames.add(normalized);
        savePlayedNames();
      }
      closeNamePrompt();
      startGame();
      updateAdminVisibility();
    }

    function recordWinner() {
      if (!playerName) return;
      const timestamp = new Date().toISOString();
      winners.push({ name: playerName, moves, timestamp });
      saveWinners();
      updateCsvLink();
    }

    function saveWinners() {
      localStorage.setItem('filterWinners', JSON.stringify(winners));
    }

    function loadWinners() {
      const data = localStorage.getItem('filterWinners');
      if (data) {
        try { winners = JSON.parse(data); } catch (e) { winners = []; }
      }
    }

    function savePlayedNames() {
      localStorage.setItem('filterPlayed', JSON.stringify(Array.from(playedNames)));
    }

    function loadPlayedNames() {
      const data = localStorage.getItem('filterPlayed');
      if (data) {
        try { playedNames = new Set(JSON.parse(data)); } catch (e) { playedNames = new Set(); }
      }
    }

    function updateAdminVisibility() {
      const link = document.getElementById('csvLink');
      const resetBtn = document.getElementById('resetWinnersBtn');
      const isAdmin = (playerName && playerName.toLowerCase() === ADMIN_USER.toLowerCase());
      if (link) link.style.display = isAdmin ? 'inline-block' : 'none';
      if (resetBtn) resetBtn.style.display = isAdmin ? 'inline-block' : 'none';
    }

    function updateCsvLink() {
      const link = document.getElementById('csvLink');
      if (!link) return;
      const header = 'Name,Moves,Timestamp\n';
      const rows = winners.map(w => `${w.name},${w.moves},${w.timestamp}`).join('\n');
      const csv = header + rows;
      link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
    }

    function resetWinners() {
      winners = [];
      saveWinners();
      updateCsvLink();
      playedNames = new Set();
      savePlayedNames();
      alert('Winners and play history reset.');
    }

    function initStorage() {
      loadWinners();
      loadPlayedNames();
      updateCsvLink();
    }

    initStorage();
  </script>
</body>
</html>
