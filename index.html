<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tableau Filter Order</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: white; min-height: 100vh; padding: 20px; transition: background 0.4s ease; }
    .container { width: 100%; max-width: 900px; margin: 0 auto; display: flex; flex-direction: column; align-items: center; }
    .landing-page { background: white; border-radius: 20px; padding: 40px 40px 60px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); animation: slideIn 0.6s ease-out; border: none; width: 100%; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .cro-header { font-size: 24px; color: #00A1E0; font-weight: 600; margin-bottom: 10px; letter-spacing: 1px; }
    .logo { width: 160px; height: auto; display: block; margin: 0 auto 16px; }
    .landing-hero { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px; flex-wrap: wrap; }
    .hero-content { flex: 1 1 320px; text-align: center; }
    .cta-row { display: flex; align-items: center; justify-content: center; gap: 12px; flex-wrap: wrap; }
    .game-title { font-size: 48px; color: #00A1E0; font-weight: 800; margin-bottom: 30px; letter-spacing: 2px; }
    .game-description { font-size: 16px; color: black; line-height: 1.8; margin-bottom: 40px; max-width: 600px; margin-left: auto; margin-right: auto; }
    .start-btn { background: #00A1E0; color: white; border: none; padding: 18px 60px; font-size: 20px; font-weight: 700; border-radius: 50px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(0,161,224,0.2); letter-spacing: 1px; }
    .start-btn:hover { transform: translateY(-3px); box-shadow: 0 15px 40px rgba(0,161,224,0.5); }
    .start-btn:active { transform: translateY(-1px); }
    .game-page { display: none; background: white; border-radius: 20px; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideIn 0.6s ease-out; max-width: 900px; margin: 0 auto; width: 100%; }
    .game-page.active { display: block; }
    .game-header { text-align: center; margin-bottom: 24px; }
    .game-header h1 { font-size: 36px; color: #00A1E0; margin-bottom: 6px; }
    .subtitle { font-size: 15px; color: #004B87; margin-bottom: 12px; }
    .stats { display: flex; justify-content: center; gap: 30px; margin-top: 10px; font-size: 16px; color: #666; }
    .order-wrapper { display: grid; gap: 16px; width: 100%; }
    .cards { background: #f8f9fa; padding: 20px; border-radius: 15px; border: 2px solid #e0e0e0; display: grid; gap: 10px; }
    .card { background: white; border: 2px solid #ddd; border-radius: 10px; padding: 14px; font-weight: 700; color: #00A1E0; cursor: grab; transition: all 0.2s ease; user-select: none; }
    .card:hover { border-color: #00A1E0; box-shadow: 0 8px 18px rgba(0,161,224,0.2); transform: translateY(-2px); }
    .card.dragging { opacity: 0.6; }
    .drop-target { border: 2px dashed #00A1E0; border-radius: 10px; padding: 12px; background: #e8f4fb; }
    .card.correct { border-color: #28a745; background: #ecf9f0; position: relative; box-shadow: 0 6px 12px rgba(40,167,69,0.18); }
    .card.correct::after { content: '✓ Correct spot'; color: #1e7e34; font-size: 12px; font-weight: 600; position: absolute; right: 10px; bottom: 8px; }
    .card.correct-flash { animation: pulse 0.7s ease-in-out; }
    .card.locked { cursor: default; pointer-events: none; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
    .card.color-1 { color: #00A1E0; }
    .card.color-2 { color: #28a745; }
    .card.color-3 { color: #ff9800; }
    .card.color-4 { color: #9c27b0; }
    .card.color-5 { color: #e91e63; }
    .card.color-6 { color: #3f51b5; }
    .card.color-7 { color: #009688; }
    .game-controls { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-top: 12px; }
    .game-btn { padding: 12px 30px; font-size: 16px; font-weight: 600; border: none; border-radius: 25px; cursor: pointer; transition: all 0.3s ease; }
    .btn-home { background: #00A1E0; color: white; }
    .btn-home:hover { background: #0088B3; transform: translateY(-2px); }
    .btn-link { padding: 10px 16px; border-radius: 10px; border: 2px solid #00A1E0; background: #e8f4fb; color: #004B87; font-weight: 600; text-decoration: none; cursor: pointer; display: inline-block; transition: all 0.2s ease; min-width: 160px; text-align: center; }
    .btn-link:hover { background: #00A1E0; color: #ffffff; box-shadow: 0 8px 18px rgba(0,0,0,0.08); transform: translateY(-1px); }
    .message { font-size: 16px; font-weight: 700; color: #208080; min-height: 22px; text-align: center; margin-top: 4px; }
    .win-screen { display: none; background: white; border-radius: 20px; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideIn 0.6s ease-out; max-width: 900px; width: 100%; margin: 0 auto; text-align: center; }
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; padding: 20px; z-index: 10; }
    .modal.active { display: flex; }
    .modal-content { background: #ffffff; padding: 24px; border-radius: 14px; max-width: 360px; width: 100%; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; }
    .modal-content h3 { margin-bottom: 12px; color: #004B87; }
    .modal-content input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ccc; margin-bottom: 12px; font-size: 16px; }
    .modal-actions { display: flex; gap: 10px; justify-content: center; }
    @media (max-width: 768px) { .game-title { font-size: 36px; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="landing-page" id="landingPage">
      <img class="logo" src="logo.png" alt="Logo">
      <div class="landing-hero">
        <div class="hero-content">
          <div class="cro-header">CRO Curiosity Cove</div>
          <h1 class="game-title">Filter Order</h1>
          <p class="game-description">Arrange Tableau filter operations in their correct execution order.</p>
          <div class="cta-row">
            <button class="start-btn" onclick="openNamePrompt()">Start Game</button>
          </div>
        </div>
      </div>
    </div>

    <div class="game-page" id="gamePage">
      <div class="game-header">
        <h1>Tableau Filter Order</h1>
        <div class="subtitle">Drag to reorder filters from first applied to last.</div>
        <div class="stats">
          <span>Time: <strong id="timer">00:00</strong></span>
        </div>
      </div>

      <div class="order-wrapper">
        <div class="cards" id="cardList"></div>
        <div class="message" id="message"></div>
        <div class="game-controls">
          <button class="btn-link" onclick="checkProgress()">Check progress</button>
          <button class="btn-link" onclick="submitAnswers()">Submit answers</button>
          <button class="game-btn btn-home" onclick="goHome()">Back to Home</button>
          <a id="sheetLink" class="btn-link" href="#" target="_blank" style="display:none;">Open results sheet</a>
        </div>
      </div>
    </div>

    <div class="win-screen" id="winScreen">
      <h1 style="color:#00A1E0; margin-bottom:12px;">Congratulations!</h1>
      <p style="margin-bottom:12px; color:#004B87;">You nailed the filter order.</p>
      <p id="winDetails" style="margin-bottom:12px; color:#004B87;"></p>
      <img src="champ.png" alt="Champion badge" style="width:260px; height:auto; margin:16px auto; display:block;">
      <div class="game-controls" style="justify-content:center; margin-top:16px;">
        <button class="game-btn btn-home" onclick="goHome()">Back to Home</button>
        <a id="sheetLinkWin" class="btn-link" href="#" target="_blank" style="display:none;">Open results sheet</a>
      </div>
    </div>

    <div class="modal" id="nameModal">
      <div class="modal-content">
        <h3>Enter your name</h3>
        <input type="text" id="playerNameInput" placeholder="Your name" />
        <div class="modal-actions">
          <button class="start-btn" style="padding:10px 20px; border-radius:10px;" onclick="confirmName()">Start</button>
          <button class="game-btn btn-home" style="padding:10px 20px; border-radius:10px;" onclick="closeNamePrompt()">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const SUBMIT_URL = 'https://script.google.com/macros/s/AKfycbyNoSx3IRXUAupgKkwXBlltcPSP-NTd0NvAdCauPyasoJcQPdW7ThkPrIGqBqwxyDbM/exec';
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1d_Cx6l-HHESCqxzHry1I3479j1FY9s6iif1Qq6DQUIk/edit';
    const ADMIN_USER = 'reneepriego';
    const APP_VERSION = 'filter-order-v1';
    const CORRECT_ORDER = [
      'Extract filters',
      'Data source filters',
      'Context filters',
      'Set filters',
      'Dimension filters',
      'Measure filters',
      'Table calc filters'
    ];

    let currentOrder = [];
    let playerName = '';
    let startTime = 0;
    let timerInterval = null;
    let finishedTime = null;
    let gameCompleted = false;
    let hasSubmittedWin = false;
    let showCorrectIndicators = false;

    function shuffle(arr) {
      return [...arr].sort(() => Math.random() - 0.5);
    }

    function shuffleOrderAvoidingCorrect() {
      let attempt = 0;
      const maxAttempts = 50;
      while (attempt < maxAttempts) {
        const candidate = shuffle(CORRECT_ORDER);
        const hasFixedPoints = candidate.some((item, i) => item === CORRECT_ORDER[i]);
        if (!hasFixedPoints) return candidate;
        attempt++;
      }
      return shuffle(CORRECT_ORDER);
    }

    function buildCards() {
      currentOrder = shuffleOrderAvoidingCorrect();
      renderCards();
      setStatusMessage('');
      resetTimer();
      gameCompleted = false;
      hasSubmittedWin = false;
      showCorrectIndicators = false;
    }

    function renderCards(options = {}) {
      const { flashIndex = null } = options;
      const list = document.getElementById('cardList');
      list.innerHTML = '';
      currentOrder.forEach((text, idx) => {
        const card = document.createElement('div');
        card.className = `card color-${(idx % 7) + 1}`;
        card.textContent = text;
        const isCorrectSpot = text === CORRECT_ORDER[idx];
        const isLocked = gameCompleted; // only lock after full completion
        card.draggable = !isLocked;
        card.dataset.index = idx;
        card.addEventListener('dragstart', onDragStart);
        card.addEventListener('dragover', onDragOver);
        card.addEventListener('drop', onDrop);
        card.addEventListener('dragend', onDragEnd);
        card.addEventListener('dragenter', onDragEnter);
        card.addEventListener('dragleave', onDragLeave);
        if (showCorrectIndicators && isCorrectSpot) card.classList.add('correct');
        if (showCorrectIndicators && isCorrectSpot && flashIndex === idx) card.classList.add('correct-flash');
        if (isLocked) card.classList.add('locked');
        list.appendChild(card);
      });
    }

    let dragIndex = null;
    function onDragStart(e) {
      if (gameCompleted || e.target.classList.contains('locked')) return;
      showCorrectIndicators = false;
      setStatusMessage('');
      dragIndex = Number(e.target.dataset.index);
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.dropEffect = 'move';
      e.dataTransfer.setData('text/plain', e.target.textContent);
      e.target.classList.add('dragging');
    }

    function onDragOver(e) {
      if (gameCompleted || e.currentTarget.classList.contains('locked')) return;
      e.preventDefault();
      const target = e.currentTarget;
      clearDropTargets();
      target.classList.add('drop-target');
    }

    function onDragEnter(e) {
      if (gameCompleted || e.currentTarget.classList.contains('locked')) return;
      e.preventDefault();
      clearDropTargets();
      e.currentTarget.classList.add('drop-target');
    }

    function onDragLeave(e) {
      if (gameCompleted || e.currentTarget.classList.contains('locked')) return;
      e.currentTarget.classList.remove('drop-target');
    }

    function onDrop(e) {
      if (gameCompleted || e.currentTarget.classList.contains('locked')) return;
      e.preventDefault();
      const targetIndex = Number(e.currentTarget.dataset.index);
      if (dragIndex === null || targetIndex === dragIndex) return;
      const item = currentOrder.splice(dragIndex, 1)[0];
      currentOrder.splice(targetIndex, 0, item);
      dragIndex = null;
      cleanDropStyles();
      renderCards({ flashIndex: targetIndex });
      // No auto-check; user triggers via buttons.
    }

    function onDragEnd() {
      dragIndex = null;
      cleanDropStyles();
    }

    function clearDropTargets() {
      document.querySelectorAll('.card.drop-target').forEach(c => c.classList.remove('drop-target'));
    }

    function cleanDropStyles() {
      clearDropTargets();
      document.querySelectorAll('.card').forEach(c => c.classList.remove('dragging'));
    }

    function evaluateOrder() {
      const correctCount = currentOrder.reduce((count, item, i) => count + (item === CORRECT_ORDER[i] ? 1 : 0), 0);
      const isCorrect = correctCount === CORRECT_ORDER.length;
      return { correctCount, isCorrect };
    }

    function checkProgress() {
      showCorrectIndicators = true;
      const { correctCount } = evaluateOrder();
      renderCards();
      if (correctCount === 0) {
        setStatusMessage('No filters are in the right spot yet. Keep going!');
      } else {
        setStatusMessage(`${correctCount}/${CORRECT_ORDER.length} filters highlighted in green.`);
      }
    }

    function submitAnswers() {
      showCorrectIndicators = true;
      const { correctCount, isCorrect } = evaluateOrder();
      renderCards();
      if (isCorrect) {
        gameCompleted = true;
        if (finishedTime === null) finishedTime = Date.now();
        updateTimer();
        stopTimer();
        setStatusMessage('✓ Correct order! Saving result...');
        lockCards();
        recordWinner();
        setTimeout(showWinScreen, 10000);
      } else {
        gameCompleted = true;
        stopTimer();
        lockCards();
        setStatusMessage(`Submitted with ${correctCount}/${CORRECT_ORDER.length} correct. Game over.`);
      }
    }

    function lockCards() {
      document.querySelectorAll('.card').forEach(card => {
        card.draggable = false;
        card.classList.add('locked');
      });
    }

    function showWinScreen() {
      document.getElementById('gamePage').classList.remove('active');
      stopTimer();
      document.getElementById('winDetails').textContent = `Completed in ${formatTimeElapsed()}.`;
      document.getElementById('winScreen').style.display = 'block';
    }

    function startGame() {
      document.getElementById('landingPage').style.display = 'none';
      document.getElementById('winScreen').style.display = 'none';
      document.getElementById('gamePage').classList.add('active');
      buildCards();
      startTimer();
    }

    function goHome() {
      stopTimer();
      document.getElementById('gamePage').classList.remove('active');
      document.getElementById('landingPage').style.display = 'block';
      document.getElementById('winScreen').style.display = 'none';
      document.getElementById('message').textContent = '';
    }

    function openNamePrompt() {
      document.getElementById('nameModal').classList.add('active');
      document.getElementById('playerNameInput').value = playerName || '';
      setTimeout(() => document.getElementById('playerNameInput').focus(), 0);
    }

    function closeNamePrompt() {
      document.getElementById('nameModal').classList.remove('active');
    }

    function confirmName() {
      const nameVal = document.getElementById('playerNameInput').value.trim();
      if (!nameVal) return;
      playerName = nameVal;
      closeNamePrompt();
      startGame();
      updateAdminVisibility();
    }

    function recordWinner() {
      if (!playerName || hasSubmittedWin) return;
      hasSubmittedWin = true;
      const payload = {
        name: playerName,
        score: getElapsedSeconds(),
        time: formatTimeElapsed(),
        timestamp: new Date().toISOString(),
        version: APP_VERSION
      };

      fetch(SUBMIT_URL, {
        method: 'POST',
        mode: 'no-cors', // allow calls from local file without CORS blocking
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).then(res => {
        if (res.type === 'opaque' || res.ok) {
          return;
        }
        hasSubmittedWin = false;
        console.error('Score submission failed with status', res.status);
        setStatusMessage('Could not save result (server error). Please try again.');
      }).catch(err => {
        hasSubmittedWin = false;
        console.error('Error submitting score', err);
        setStatusMessage('Could not save result (network error).');
      });
    }

    function updateAdminVisibility() {
      const adminLinks = ['sheetLink', 'sheetLinkWin']
        .map(id => document.getElementById(id))
        .filter(Boolean);
      const isAdmin = playerName && playerName.toLowerCase() === ADMIN_USER.toLowerCase();
      adminLinks.forEach(link => {
        link.style.display = isAdmin ? 'inline-block' : 'none';
        if (isAdmin) {
          link.href = SHEET_URL;
        }
      });
    }

    function startTimer() {
      stopTimer();
      startTime = Date.now();
      finishedTime = null;
      timerInterval = setInterval(updateTimer, 1000);
      updateTimer();
    }

    function stopTimer() {
      clearInterval(timerInterval);
      timerInterval = null;
    }

    function resetTimer() {
      startTime = 0;
      finishedTime = null;
      document.getElementById('timer').textContent = '00:00';
    }

    function updateTimer() {
      document.getElementById('timer').textContent = formatTimeElapsed();
    }

    function getElapsedSeconds() {
      if (!startTime) return 0;
      const endPoint = finishedTime || Date.now();
      return Math.floor((endPoint - startTime) / 1000);
    }

    function formatTimeElapsed() {
      const elapsed = getElapsedSeconds();
      const minutes = String(Math.floor(elapsed / 60)).padStart(2, '0');
      const seconds = String(elapsed % 60).padStart(2, '0');
      return `${minutes}:${seconds}`;
    }

    function setStatusMessage(text) {
      const messageEl = document.getElementById('message');
      if (messageEl) messageEl.textContent = text;
    }
  </script>
</body>
</html>
